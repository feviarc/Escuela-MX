<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Escuelas</ion-title>
    @if(isLoadingData) {
      <ion-progress-bar color="warning" type="indeterminate"></ion-progress-bar>
    }
  </ion-toolbar>
  <ion-toolbar color="light">
    <ion-buttons slot="primary">
      <ion-button fill="outline" color="primary" id="classes-btn">
        <ion-icon name="people" slot="start"></ion-icon>
        Grupos
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="primary">
      <ion-button fill="outline" color="primary" id="courses-btn">
        <ion-icon name="school" slot="start"></ion-icon>
        Materias
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

@if(isSpinnerActive) {
  <div class="container__spinner">
    <ion-spinner color="primary"></ion-spinner>
    <p>{{ spinnerText }}</p>
  </div>
}

@if(!isSpinnerActive) {
  <ion-content>
    <ion-list>
      @for(school of schools; track school.id) {
        <ion-item-sliding class="sliding-item-card" #schoolSlidingItem>
          <ion-item-options side="start">
            <ion-item-option id="delete-{{ school.id }}" color="danger">
              <ion-icon slot="icon-only" name="trash"></ion-icon>
            </ion-item-option>
            <ion-action-sheet
             trigger="delete-{{ school.id }}"
             header="Estás a punto de eliminar"
             subHeader="{{ school.nombre }}"
             [buttons]="actionSheetButtons"
             (didDismiss)="onDeleteSchool($event, schoolSlidingItem, school)"
            >
            </ion-action-sheet>
          </ion-item-options>
          <ion-item class="custom-item">
            <ion-label>
              <h2>{{ school.nombre }}</h2>
              <p>{{ school.cct }}</p>
            </ion-label>
            <ion-chip>PIN: <strong>{{ school.pin }}</strong></ion-chip>
          </ion-item>
          <ion-item-options side="end">
            <ion-item-option id="edit-{{ school.id }}">
              <ion-icon slot="icon-only" name="create"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>

        <!-- Modal (Actualizar escuela) -->
        <ion-modal
         trigger="edit-{{school.id}}"
         [initialBreakpoint]="0.60"
         [breakpoints]="breakpoints"
         (didDismiss)="onModalDismiss(schoolSlidingItem)"
        >
          <ng-template>
            <ion-header>
              <ion-toolbar color="primary">
                <ion-buttons slot="start">
                  <ion-button (click)="closeModal('edit-'+school.id)">Cancelar</ion-button>
                </ion-buttons>
                <ion-title>Editar Escuela</ion-title>
                <ion-buttons slot="end">
                  <ion-button
                   [strong]="true"
                   [disabled]="isNotDataChanged(school, nameEditInput, pinEditInput)"
                   (click)="onUpdateSchool(school, nameEditInput, pinEditInput)"
                  >
                    Guardar
                  </ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content color="light">
                <form>
                  <ion-list [inset]="true">
                    <ion-item>
                      <ion-input
                       label="CCT (Clave del Centro de Trabajo)"
                       labelPlacement="stacked"
                       value="{{ school.cct }}"
                       disabled
                      >
                      </ion-input>
                    </ion-item>
                  </ion-list>
                  <ion-list [inset]="true">
                    <ion-item>
                      <ion-input
                       class="input__text--uppercase"
                       label="Nombre de la escuela"
                       labelPlacement="stacked"
                       maxlength="100"
                       value = "{{ school.nombre }}"
                       #nameEditInput
                      >
                      </ion-input>
                    </ion-item>
                  </ion-list>
                  <ion-list [inset]="true">
                    <ion-input-otp value="{{  school.pin }}" #pinEditInput>
                      <ion-label>PIN</ion-label>
                    </ion-input-otp>
                  </ion-list>
                </form>
            </ion-content>
          </ng-template>
        </ion-modal>
      }
    </ion-list>
    <ion-toast
     cssClass="page__toast"
     [message]="toastMessage"
     [isOpen]="isToastOpen"
     [duration]="5000"
     (didDismiss)="this.setOpenToast(false)"
    >
    </ion-toast>
  </ion-content>
}

<!-- Modal (Nueva Escuela) -->
<ion-modal
 trigger="new-school-btn"
 (willDismiss)="closeModal('new-school-btn')"
 [initialBreakpoint]="0.60"
 [breakpoints]="breakpoints"
>
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-buttons slot="start">
          <ion-button (click)="closeModal('new-school-btn')">Cancelar</ion-button>
        </ion-buttons>
        <ion-title>Nueva Escuela</ion-title>
        <ion-buttons slot="end">
          <ion-button
           (click)="onAddSchool()"
           [strong]="true"
           [disabled]="!schoolForm.valid || isSaveButtonDisabled"
           type="submit"
          >
            Guardar
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding" color="light">
      <form [formGroup]="schoolForm">
        <ion-list [inset]="true">
          <ion-item>
            <ion-input
             formControlName="cct"
             label="CCT (Clave del Centro de Trabajo)"
             labelPlacement="stacked"
             maxlength="10"
            >
            </ion-input>
          </ion-item>
          @if(cct.invalid && cct.touched) {
            <ion-text color="danger" class="ion-padding">
              @if(cct.errors?.['cctExists']) {
                <small>Esta clave ya fue registrada previamente.</small>
              }
            </ion-text>
          }
        </ion-list>
        <ion-list [inset]="true">
          <ion-item>
            <ion-input
             formControlName="nombre"
             label="Nombre de la escuela"
             labelPlacement="stacked"
             maxlength="100"
            >
            </ion-input>
          </ion-item>
        </ion-list>
        <ion-list [inset]="true">
          <ion-input-otp [value]="pin" disabled>
            <ion-label>PIN</ion-label>
          </ion-input-otp>
        </ion-list>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal (Grupos) -->
<ion-modal
 class="modal-classes__item"
 trigger="classes-btn"
 (willDismiss)="closeModal('classes-btn')"
 [initialBreakpoint]="initialBreakpoint"
 [breakpoints]="breakpoints"
>
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-buttons slot="start">
          <ion-button (click)="closeModal('classes-btn');">
            Cerrar
          </ion-button>
        </ion-buttons>
        <ion-title>Grupos</ion-title>
      </ion-toolbar>
      <ion-grid>
        <ion-row>
          <ion-col></ion-col>
          <ion-col>
            <ion-input-otp type="text" length="1" pattern="[1-3]" [(ngModel)]="classGrade"></ion-input-otp>
          </ion-col>
          <ion-col>
            <ion-input-otp type="text" length="1" pattern="[a-zA-Z]" [(ngModel)]="classLetter" ></ion-input-otp>
          </ion-col>
          <ion-col>
            <ion-fab vertical="center" horizontal="center">
              <ion-fab-button
               size="small"
               [disabled]="!isValidClass()"
               (click)="onAddClass()"
              >
                <ion-icon name="add"></ion-icon>
              </ion-fab-button>
            </ion-fab>
          </ion-col>
          <ion-col></ion-col>
        </ion-row>
        <ion-row>
          <ion-col></ion-col>
          <ion-col>
            <ion-label>
              <p>Grado</p>
            </ion-label>
          </ion-col>
          <ion-col>
            <ion-label>
              <p>Grupo</p>
            </ion-label>
          </ion-col>
          <ion-col></ion-col>
          <ion-col></ion-col>
        </ion-row>
      </ion-grid>
    </ion-header>
    <ion-content class="ion-padding" color="light">
      <ion-list>
        @for(group of groups; track group.id) {
          <ion-item-sliding #groupSlidingItem>
            <ion-item>
              <ion-label>{{ group.nombre }}</ion-label>
            </ion-item>
            <ion-item-options side="start">
              <ion-item-option color="danger" (click)="onDeleteGroup(group)">
                <ion-icon slot="icon-only" name="trash"></ion-icon>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        }
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal (Materias) -->
<ion-modal
 trigger="courses-btn"
 (willDismiss)="closeModal('courses-btn')"
 [initialBreakpoint]="initialBreakpoint"
 [breakpoints]="breakpoints"
>
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-buttons slot="start">
          <ion-button (click)="closeModal('courses-btn');">
            Cerrar
          </ion-button>
        </ion-buttons>
        <ion-title>Materias</ion-title>
      </ion-toolbar>
      <ion-grid class="background--light">
        <ion-row class="ion-align-items-center">
          <!-- Input ocupa todo el espacio disponible -->
          <ion-col size="10">
            <ion-list class="margin-bottom--none" [inset]="true">
              <ion-item>
                <ion-input
                 label="Nueva materia"
                 labelPlacement="stacked"
                 placeholder="Nombre"
                 class="input__text--uppercase"
                 [(ngModel)]="subjectName"
                 (keyup.enter)="onAddSubject()"
                ></ion-input>
              </ion-item>
            </ion-list>
          </ion-col>
          <!-- Botón con tamaño automático -->
          <ion-col size="2">
            <ion-button
             shape="round"
             color="primary"
             [disabled]="!isValidSubject()"
             (click)="onAddSubject()"
             class="add-subject-btn"
            >
              <ion-icon slot="icon-only" name="add"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
        <ion-row class="ion-align-items-center">
          <ion-col size="10">
            <ion-list class="margin-top--none margin-bottom--none" [inset]="true">
              <ion-radio-group value="1" [compareWith]="compareWith" (ionChange)="gradeHandleChange($event)">
                <ion-item>
                  <ion-radio value="1" justify="space-between">Primero</ion-radio>
                </ion-item>
                <ion-item>
                  <ion-radio value="2" justify="space-between">Segundo</ion-radio>
                </ion-item>
                <ion-item>
                  <ion-radio value="3" justify="space-between">Tercero</ion-radio>
                </ion-item>
              </ion-radio-group>
            </ion-list>
          </ion-col>
          <ion-col>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-header>
    <ion-content class="ion-padding" color="light">
      <ion-list>
      @for(subject of subjects; track subject.id) {
        <ion-item-sliding #subjectSlidingItem>
          <ion-item>
            <ion-label>{{ subject.nombre }}</ion-label>
            <ion-chip>{{ subject.grado }}°</ion-chip>
          </ion-item>
          <ion-item-options side="start">
            <ion-item-option color="danger" (click)="onDeleteSubject(subject)">
              <ion-icon slot="icon-only" name="trash"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      }
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-fab slot="fixed" vertical="bottom" horizontal="end">
  <ion-fab-button size="small" id="new-school-btn">
    <ion-icon name="add"></ion-icon>
  </ion-fab-button>
</ion-fab>
